import os
import re

# ==========================================
# ğŸ“‚ ì„¤ì •: ì„±ê²© í˜ì´ì§€ê°€ ìˆëŠ” í´ë”
# ==========================================
TARGET_FOLDER = "./traits" 

# ==========================================
# ğŸ“ ë°ì´í„° ë§¤í•‘ (íŒŒì¼ëª… -> í•œê¸€ ë³€í™˜ìš©)
# ==========================================
ZODIACS = {
    'rat': 'ì¥ë ', 'ox': 'ì†Œë ', 'tiger': 'í˜¸ë‘ì´ë ', 'rabbit': 'í† ë¼ë ',
    'dragon': 'ìš©ë ', 'snake': 'ë±€ë ', 'horse': 'ë§ë ', 'goat': 'ì–‘ë ',
    'monkey': 'ì›ìˆ­ì´ë ', 'rooster': 'ë‹­ë ', 'dog': 'ê°œë ', 'pig': 'ë¼ì§€ë '
}
GENDERS = {'m': 'ë‚¨ì„±', 'f': 'ì—¬ì„±'}

# ==========================================
# 1. ì‚½ì…í•  HTML (êµ­ê¸° ë²„íŠ¼)
# ==========================================
FLAG_HTML = """
    <!-- ğŸŒ ìë™ ì‚½ì…ëœ ë‹¤êµ­ì–´ ë²„íŠ¼ -->
    <div class="translation-flags">
        <a href="javascript:void(0)" onclick="triggerTranslate('ko')" class="flag-btn" title="í•œêµ­ì–´"><img src="https://flagcdn.com/w80/kr.png" alt="KR"></a>
        <a href="javascript:void(0)" onclick="triggerTranslate('en')" class="flag-btn" title="English"><img src="https://flagcdn.com/w80/us.png" alt="US"></a>
        <a href="javascript:void(0)" onclick="triggerTranslate('zh-CN')" class="flag-btn" title="ä¸­æ–‡"><img src="https://flagcdn.com/w80/cn.png" alt="CN"></a>
        <a href="javascript:void(0)" onclick="triggerTranslate('ja')" class="flag-btn" title="æ—¥æœ¬èª"><img src="https://flagcdn.com/w80/jp.png" alt="JP"></a>
        <a href="javascript:void(0)" onclick="triggerTranslate('th')" class="flag-btn" title="à¹„à¸—à¸¢"><img src="https://flagcdn.com/w80/th.png" alt="TH"></a>
        <a href="javascript:void(0)" onclick="triggerTranslate('vi')" class="flag-btn" title="Tiáº¿ng Viá»‡t"><img src="https://flagcdn.com/w80/vn.png" alt="VN"></a>
        <a href="javascript:void(0)" onclick="triggerTranslate('id')" class="flag-btn" title="Indonesia"><img src="https://flagcdn.com/w80/id.png" alt="ID"></a>
        <a href="javascript:void(0)" onclick="triggerTranslate('es')" class="flag-btn" title="EspaÃ±ol"><img src="https://flagcdn.com/w80/es.png" alt="ES"></a>
        <a href="javascript:void(0)" onclick="triggerTranslate('fr')" class="flag-btn" title="FranÃ§ais"><img src="https://flagcdn.com/w80/fr.png" alt="FR"></a>
    </div>
    <div id="google_translate_element" style="display:none;"></div>
"""

# ==========================================
# 2. ì‚½ì…í•  CSS (ë²ˆì—­ë°” ì œê±° + ìŠ¤íƒ€ì¼)
# ==========================================
CSS_CODE = """
    <style>
        /* ğŸŒ êµ­ê¸° ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        .translation-flags {
            display: flex; justify-content: center; gap: 12px;
            padding: 20px 0 10px; flex-wrap: wrap; position: relative; z-index: 10001;
        }
        .flag-btn {
            display: block; width: 36px; height: 36px; border-radius: 50%; overflow: hidden;
            border: 2px solid rgba(255, 255, 255, 0.6); box-shadow: 0 3px 6px rgba(0,0,0,0.1);
            transition: all 0.2s; cursor: pointer; background: white;
        }
        .flag-btn img { width: 100%; height: 100%; object-fit: cover; transform: scale(1.1); }
        .flag-btn:hover { transform: translateY(-3px) scale(1.15); border-color: #D4A84B; }

        /* ğŸš« êµ¬ê¸€ ë²ˆì—­ ìƒë‹¨ ë°” ê°•ì œ ì œê±° */
        body { top: 0 !important; position: static !important; min-height: 100vh !important; }
        .goog-te-banner-frame { display: none !important; height: 0 !important; visibility: hidden !important; }
        .goog-tooltip { display: none !important; }
        .goog-text-highlight { background-color: transparent !important; box-shadow: none !important; }
        
        /* ëª¨ë°”ì¼ ìµœì í™” */
        @media (max-width: 480px) {
            .translation-flags {
                justify-content: flex-start; overflow-x: auto;
                padding-left: 20px; padding-right: 20px; white-space: nowrap; flex-wrap: nowrap;
                scrollbar-width: none;
            }
            .translation-flags::-webkit-scrollbar { display: none; }
            .flag-btn { flex: 0 0 auto; }
        }
    </style>
"""

# ==========================================
# 3. ì‚½ì…í•  JS (ì–¸ì–´ ê¸°ì–µ + ìƒë‹¨ë°” ê°•ì œ ì‚­ì œ)
# ==========================================
JS_CODE = """
    <script>
    function googleTranslateElementInit() {
        new google.translate.TranslateElement({
            pageLanguage: 'ko',
            includedLanguages: 'ko,en,zh-CN,ja,th,vi,id,es,fr',
            autoDisplay: false
        }, 'google_translate_element');

        setTimeout(function() {
            const savedLang = localStorage.getItem('selectedLang');
            if (savedLang && savedLang !== 'ko') {
                triggerTranslate(savedLang);
            }
        }, 500);

        setInterval(function() {
            if (document.body.style.top !== "0px") document.body.style.top = "0px";
            const banner = document.querySelector('.goog-te-banner-frame');
            if (banner) banner.style.display = 'none';
        }, 1000);
    }

    function triggerTranslate(langCode) {
        const select = document.querySelector('.goog-te-combo');
        if (select) {
            select.value = langCode;
            select.dispatchEvent(new Event('change'));
            localStorage.setItem('selectedLang', langCode);
        }
    }

    (function() {
        var gtScript = document.createElement('script');
        gtScript.type = 'text/javascript';
        gtScript.async = true;
        gtScript.src = "//translate.google.com/translate_a/element.js?cb=googleTranslateElementInit";
        document.body.appendChild(gtScript);
    })();
    </script>
"""

def update_seo_and_translation():
    count = 0
    if not os.path.exists(TARGET_FOLDER):
        print(f"âŒ ì˜¤ë¥˜: '{TARGET_FOLDER}' í´ë”ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")
        return

    for filename in os.listdir(TARGET_FOLDER):
        if filename.endswith(".html"):
            # íŒŒì¼ëª… ë¶„ì„ (ì˜ˆ: rat-m.html -> rat, m)
            try:
                name_part = filename.replace(".html", "")
                zodiac_eng, gender_eng = name_part.split('-')
                
                zodiac_kor = ZODIACS.get(zodiac_eng, "")
                gender_kor = GENDERS.get(gender_eng, "")
                
                if not zodiac_kor or not gender_kor:
                    continue # íŒŒì¼ëª… í˜•ì‹ì´ ë‹¤ë¥´ë©´ íŒ¨ìŠ¤
                    
            except:
                continue

            file_path = os.path.join(TARGET_FOLDER, filename)
            
            with open(file_path, 'r', encoding='utf-8') as f:
                content = f.read()
            
            # ==========================================
            # ğŸš€ 1. ê°•ë ¥í•œ SEO íƒœê·¸ ì£¼ì… (ê¸°ì¡´ íƒœê·¸ êµì²´)
            # ==========================================
            
            # (1) Title íƒœê·¸ ìµœì í™”
            new_title = f"<title>{zodiac_kor} {gender_kor} ì„±ê²©ê³¼ ìš´ì„¸ ì™„ë²½ ë¶„ì„ | ë ë³„ ì‚¬ë‘ ê¶í•©</title>"
            content = re.sub(r'<title>.*?</title>', new_title, content)
            
            # (2) Meta Description ìµœì í™”
            new_desc = f'<meta name="description" content="{zodiac_kor} {gender_kor}ì˜ íƒ€ê³ ë‚œ ì„±ê²©, ì—°ì•  ìŠ¤íƒ€ì¼, ì¥ë‹¨ì  ë° ì¬ë¬¼ìš´ì„ ìƒì„¸í•˜ê²Œ ë¶„ì„í•´ ë“œë¦½ë‹ˆë‹¤. ë¬´ë£Œ ë ë³„ ìš´ì„¸ í™•ì¸í•˜ì„¸ìš”.">'
            if '<meta name="description"' in content:
                content = re.sub(r'<meta name="description" content=".*?">', new_desc, content)
            else:
                # ì—†ìœ¼ë©´ head ì•ˆì— ì¶”ê°€
                content = content.replace("<head>", f"<head>\n    {new_desc}")

            # (3) Open Graph (SNS ê³µìœ ìš©) íƒœê·¸ ì¶”ê°€/êµì²´
            og_tags = f"""
    <meta property="og:type" content="article">
    <meta property="og:title" content="{zodiac_kor} {gender_kor} ì„±ê²©ê³¼ ìš´ì„¸ ë¶„ì„">
    <meta property="og:description" content="{zodiac_kor} {gender_kor}ì˜ ì„±ê²©, ì—°ì• , ì¬ë¬¼ìš´ì„ í™•ì¸í•´ë³´ì„¸ìš”.">
    <meta property="og:image" content="https://zodiac.techpawz.com/images/zodiac/{zodiac_eng}.png">
            """
            # ê¸°ì¡´ OG íƒœê·¸ê°€ ìˆìœ¼ë©´ ì§€ìš°ê³  ìƒˆë¡œ ë„£ê¸° (ì¤‘ë³µ ë°©ì§€ ë¡œì§ì€ ë³µì¡í•˜ë‹ˆ, head ì•ì— ê¹”ë”í•˜ê²Œ ë„£ìŒ)
            if '<meta property="og:title"' not in content:
                content = content.replace("</head>", f"{og_tags}\n</head>")

            # (4) íŒŒë¹„ì½˜ ê²½ë¡œ ì ˆëŒ€ê²½ë¡œë¡œ ìˆ˜ì •
            # ê¸°ì¡´ íŒŒë¹„ì½˜ ì½”ë“œê°€ ìˆë‹¤ë©´ êµì²´, ì—†ìœ¼ë©´ ë†”ë‘  (ë³´í†µ í…œí”Œë¦¿ì— ìˆìœ¼ë¯€ë¡œ)
            fav_code = '<link rel="icon" href="data:image/svg+xml,<svg xmlns=\'http://www.w3.org/2000/svg\' viewBox=\'0 0 100 100\'><style>.bg{fill:%23FDF8F0;}.knot{fill:none;stroke:%23C73E3A;stroke-width:8;stroke-linecap:round;}</style><circle cx=\'50\' cy=\'50\' r=\'48\' class=\'bg\'/><path d=\'M30,35 Q50,15 70,35 T30,65 Q50,85 70,65\' class=\'knot\'/><text x=\'50\' y=\'55\' font-size=\'40\' text-anchor=\'middle\' dominant-baseline=\'middle\'>ğŸ’˜</text></svg>">'
            content = re.sub(r'<link rel="icon".*?>', fav_code, content)

            # ==========================================
            # ğŸš€ 2. ë²ˆì—­ ê¸°ëŠ¥ ì£¼ì… (CSS, HTML, JS)
            # ==========================================
            
            # CSS ë„£ê¸° (ì¤‘ë³µ ë°©ì§€)
            if "/* ğŸŒ êµ­ê¸° ë²„íŠ¼ ìŠ¤íƒ€ì¼ */" not in content:
                content = content.replace("</head>", CSS_CODE + "\n</head>")
            
            # êµ­ê¸° ë²„íŠ¼ ë„£ê¸° (body ë°”ë¡œ ë’¤)
            if "translation-flags" not in content:
                if '<div class="main-content">' in content:
                     content = content.replace('<div class="main-content">', '<div class="main-content">\n' + FLAG_HTML)
                elif "<body" in content:
                    body_end = content.find(">", content.find("<body")) + 1
                    content = content[:body_end] + "\n" + FLAG_HTML + content[body_end:]

            # JS ë„£ê¸° (body ë‹«ê¸° ì „)
            if "googleTranslateElementInit" not in content:
                content = content.replace("</body>", JS_CODE + "\n</body>")

            # íŒŒì¼ ì €ì¥
            with open(file_path, 'w', encoding='utf-8') as f:
                f.write(content)
            
            print(f"âœ… ì—…ë°ì´íŠ¸ ì™„ë£Œ: {filename} ({zodiac_kor} {gender_kor})")
            count += 1

    print(f"\nğŸ‰ ì´ {count}ê°œ íŒŒì¼ SEO ë° ë²ˆì—­ ê¸°ëŠ¥ ì—…ë°ì´íŠ¸ ì™„ë£Œ!")

if __name__ == "__main__":
    update_seo_and_translation()
